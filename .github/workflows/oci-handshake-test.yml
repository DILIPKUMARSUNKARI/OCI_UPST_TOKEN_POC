name: OCI Keyless Auth Test

on: [workflow_dispatch]

jobs:
  test-auth:
    runs-on: ubuntu-latest
    permissions:
      id-token: write   # REQUIRED for OIDC
      contents: read

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- STEP 1: Get Token & Verify Repo Name ---
      - name: Get GitHub OIDC Token
        id: get-id-token
        run: |
          # 1. Request the token
          token=$(curl -sLS "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=${{ secrets.IDCS_CLIENT_ID }}" \
            -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" | jq -r '.value')
          
          # 2. Mask it so it doesn't leak in logs
          echo "::add-mask::$token"
          echo "id_token=$token" >> $GITHUB_OUTPUT

          # 3. DEBUG: Print the Subject (Safe) to confirm Repo Case
          echo "=========================================="
          echo "üïµÔ∏è DEBUG: VERIFYING TOKEN SUBJECT..."
          TOKEN_SUB=$(jq -R 'split(".") | .[1] | @base64d | fromjson | .sub' <<< "$token")
          echo "‚úÖ Token Subject: $TOKEN_SUB"
          echo "=========================================="

      # --- STEP 2: Generate Session Keys ---
      - name: Generate Session Key
        run: |
          mkdir -p .oci
          openssl genrsa -out .oci/session_key.pem 2048
          openssl rsa -pubout -in .oci/session_key.pem -out .oci/session_key_public.pem
          
          # Format key for API
          PUBLIC_KEY_ONE_LINE=$(cat .oci/session_key_public.pem | sed '1d;$d' | tr -d '\n')
          echo "PUBLIC_KEY=$PUBLIC_KEY_ONE_LINE" >> $GITHUB_ENV

      # --- STEP 3: Exchange Token for OCI UPST ---
      - name: Exchange Token
        id: exchange-token
        env:
          IDCS_URL: ${{ secrets.IDCS_DOMAIN_URL }}
          CLIENT_ID: ${{ secrets.IDCS_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.IDCS_CLIENT_SECRET }}
          GH_TOKEN: ${{ steps.get-id-token.outputs.id_token }}
        run: |
          echo "üöÄ Exchanging GitHub Token for OCI Token..."
          
          RESPONSE_BODY=$(curl -s -w "\n%{http_code}" -X POST "${IDCS_URL}/oauth2/v1/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -u "${CLIENT_ID}:${CLIENT_SECRET}" \
            -d "grant_type=urn:ietf:params:oauth:grant-type:token-exchange" \
            -d "requested_token_type=urn:oci:token-type:oci-upst" \
            -d "subject_token=${GH_TOKEN}" \
            -d "subject_token_type=jwt" \
            -d "public_key=${PUBLIC_KEY}")

          # Split response body and status code
          HTTP_STATUS=$(echo "$RESPONSE_BODY" | tail -n1)
          JSON_BODY=$(echo "$RESPONSE_BODY" | sed '$d')

          if [ "$HTTP_STATUS" != "200" ]; then
